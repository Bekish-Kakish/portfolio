<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–û—Ç–∑—ã–≤—ã ‚Äî –ë–µ–∫–∑–∞—Ç –ö–∞–∫–∏–º–æ–≤</title>
  <style>
     html, body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom, #1a1a1a 0%, #121212 100%);
      color: #eee;
      overflow-x: hidden;
    }

    header {
      background: #1f1f1f;
      padding: 20px;
      text-align: center;
      font-size: 2em;
      font-weight: bold;
      color: #a0e7e5;
      text-shadow: 0 0 10px #00ffff66;
    }

    nav {
      background: #272727;
      padding: 10px;
      text-align: center;
    }

    nav a {
      color: #a0e7e5;
      margin: 0 15px;
      text-decoration: none;
      font-weight: bold;
      transition: color 0.3s;
    }

    nav a:hover {
      color: #ff4c4c;
    }

    main {
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }

    h1, h2 {
      color: #fff;
      text-shadow: 0 0 10px #00ffff66;
      border-bottom: 2px solid #444;
      padding-bottom: 10px;
    }

    .tabs {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }

    .tabs button {
      padding: 10px 20px;
      font-weight: bold;
      border: none;
      cursor: pointer;
      background: #333;
      color: #a0e7e5;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    .tabs button.active {
      background: #ff4c4c;
      color: white;
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .review-form, .reviews-list {
      background: #1e1e1e;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
      color: #a0e7e5;
    }

    input[type="text"], textarea {
      width: 100%;
      padding: 10px;
      background: #2b2b2b;
      border: 1px solid #444;
      color: #eee;
      border-radius: 5px;
      font-family: inherit;
      resize: none;
      box-sizing: border-box;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    textarea:focus, input:focus {
      outline: none;
      border-color: #ff4c4c;
    }

    textarea.auto-expand {
      overflow: hidden;
      min-height: 60px;
    }

    .stars {
      display: flex;
      flex-direction: row-reverse;
      justify-content: flex-end;
      margin-top: 10px;
    }

    .stars input { display: none; }
    .stars label {
      font-size: 1.8rem;
      color: #444;
      cursor: pointer;
      transition: color 0.3s;
    }
    .stars input:checked ~ label,
    .stars label:hover,
    .stars label:hover ~ label {
      color: #ff4c4c;
    }

    button {
      margin-top: 20px;
      padding: 10px 20px;
      border: none;
      background: #ff4c4c;
      color: white;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background: #e03e3e;
    }

    .review-item {
      border-bottom: 1px solid #444;
      padding: 15px 0;
      position: relative;
    }
    .review-stars {
      color: #ff4c4c;
      font-size: 1.2rem;
      margin-bottom: 5px;
    }
    .review-name {
      color: #a0e7e5;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .review-text {
      white-space: pre-wrap;
      font-size: 1rem;
      line-height: 1.4;
    }
    .delete-btn {
      position: absolute;
      top: 15px;
      right: 0;
      background: #ff4c4c;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 5px;
      font-size: 0.8rem;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    .delete-btn:hover {
      background: #e03e3e;
    }
  </style>
</head>
<body>
  <header>–û—Ç–∑—ã–≤—ã</header>
  <nav>
    <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
    <a href="about.html">–û —Å–µ–±–µ</a>
    <a href="projects.html">–ü—Ä–æ–µ–∫—Ç—ã</a>
    <a href="contact.html">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
    <a href="reviews.html">–û—Ç–∑—ã–≤—ã</a>
  </nav>

  <main>
    <!-- –ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è —Å—é–¥–∞ -->
    <!-- –î–æ–±–∞–≤–∏–º –∫–Ω–æ–ø–∫—É –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ –∏–∑ JS -->

    <div class="tabs">
      <button class="tab-button active" data-tab="write">–ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç–∑—ã–≤</button>
      <button class="tab-button" data-tab="view">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∑—ã–≤—ã</button>
    </div>

    <div id="write" class="tab-content active">
      <form class="review-form" id="reviewForm">
        <label for="name">–ò–º—è:</label>
        <input type="text" id="name" name="name" required autocomplete="off" />

        <label>–û—Ü–µ–Ω–∫–∞:</label>
        <div class="stars">
          <input type="radio" id="star5" name="rating" value="5" /><label for="star5">‚òÖ</label>
          <input type="radio" id="star4" name="rating" value="4" /><label for="star4">‚òÖ</label>
          <input type="radio" id="star3" name="rating" value="3" /><label for="star3">‚òÖ</label>
          <input type="radio" id="star2" name="rating" value="2" /><label for="star2">‚òÖ</label>
          <input type="radio" id="star1" name="rating" value="1" /><label for="star1">‚òÖ</label>
        </div>

        <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
        <textarea id="comment" name="comment" rows="3" class="auto-expand" required></textarea>

        <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>
    </div>

    <div id="view" class="tab-content">
      <section class="reviews-list" id="reviewsList">
        <p style="color:#888; text-align:center;">–û—Ç–∑—ã–≤—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</p>
      </section>
    </div>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // üî• –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyARTah6meZqkJAyQL5FYrNXlVWtYk_QMaM",
      authDomain: "bekish-portfolio.firebaseapp.com",
      projectId: "bekish-portfolio",
      storageBucket: "bekish-portfolio.firebasestorage.app",
      messagingSenderId: "192609156605",
      appId: "1:192609156605:web:0c923246558f58148ead94",
      measurementId: "G-Q2X3PT2VXB"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // === –ù–ê–ß–ê–õ–û: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Google ===
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();

    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—Ö–æ–¥–∞ –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º –≤ main –¥–æ –≤–∫–ª–∞–¥–æ–∫
    const loginBtn = document.createElement('button');
    loginBtn.textContent = '–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google';
    loginBtn.style = `
      background: #4285F4; 
      color: white; 
      border: none; 
      padding: 10px 15px; 
      cursor: pointer; 
      border-radius: 5px;
      font-weight: bold;
      margin-bottom: 20px;
      display: block;
      max-width: 200px;
    `;
    const main = document.querySelector('main');
    main.insertBefore(loginBtn, document.querySelector('.tabs'));

    loginBtn.addEventListener('click', () => {
      auth.signInWithPopup(provider)
        .then(result => {
          const user = result.user;
          alert(`–ü—Ä–∏–≤–µ—Ç, ${user.displayName}! –¢—ã –≤–æ—à—ë–ª.`);
          window.currentUserId = user.uid; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º UID –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
          loginBtn.style.display = 'none'; // —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
          loadReviews(); // –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–∑—ã–≤—ã, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è –µ—Å–ª–∏ –Ω–∞–¥–æ
        })
        .catch(err => {
          alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + err.message);
        });
    });

    // === –í–´–•–û–î (–¥–æ–±–∞–≤–∏–º –∫–Ω–æ–ø–∫—É –≤—ã—Ö–æ–¥–∞ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞) ===
    const logoutBtn = document.createElement('button');
    logoutBtn.textContent = '–í—ã–π—Ç–∏';
    logoutBtn.style = `
      background: #666; 
      color: white; 
      border: none; 
      padding: 10px 15px; 
      cursor: pointer; 
      border-radius: 5px;
      font-weight: bold;
      margin-bottom: 20px;
      display: none;
      max-width: 200px;
    `;
    main.insertBefore(logoutBtn, document.querySelector('.tabs'));

    logoutBtn.addEventListener('click', () => {
      auth.signOut().then(() => {
        alert('–¢—ã –≤—ã—à–µ–ª –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞');
        window.currentUserId = null;
        loginBtn.style.display = 'block';
        logoutBtn.style.display = 'none';
        loadReviews();
      });
    });

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤—Ö–æ–¥–∞
    auth.onAuthStateChanged(user => {
      if (user) {
        window.currentUserId = user.uid;
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'block';
      } else {
        window.currentUserId = null;
        loginBtn.style.display = 'block';
        logoutBtn.style.display = 'none';
      }
      loadReviews();
    });
    // === –ö–û–ù–ï–¶: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ===

    // –†–∞–±–æ—Ç–∞ —Å –≤–∫–ª–∞–¥–∫–∞–º–∏
    const tabs = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        tabContents.forEach(tc => tc.classList.remove('active'));
        const target = tab.dataset.tab;
        document.getElementById(target).classList.add('active');
      });
    });

    // –ê–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ textarea
    const textarea = document.getElementById('comment');
    textarea.addEventListener('input', () => {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    });

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞ –≤ Firestore
    const reviewForm = document.getElementById('reviewForm');
    reviewForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!window.currentUserId) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏ —á–µ—Ä–µ–∑ Google, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤.');
        return;
      }

      const name = reviewForm.name.value.trim();
      const rating = reviewForm.rating.value;
      const comment = reviewForm.comment.value.trim();

      if (!name || !rating || !comment) {
        alert('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è.');
        return;
      }

      try {
        await db.collection('reviews').add({
          name,
          rating: Number(rating),
          comment,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          userId: window.currentUserId // –¥–æ–±–∞–≤–ª—è–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã –∑–Ω–∞—Ç—å, –∫—Ç–æ –æ—Å—Ç–∞–≤–∏–ª –æ—Ç–∑—ã–≤
        });
        alert('–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤, –±—Ä–∞—Ç–∞–Ω!');
        reviewForm.reset();
        textarea.style.height = 'auto';
        loadReviews();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–∑—ã–≤–∞: ' + err.message);
      }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤ –∏–∑ Firestore
    async function loadReviews() {
      const list = document.getElementById('reviewsList');
      list.innerHTML = '<p style="color:#888; text-align:center;">–û—Ç–∑—ã–≤—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</p>';
      try {
        const snapshot = await db.collection('reviews').orderBy('timestamp', 'desc').get();
        if (snapshot.empty) {
          list.innerHTML = '<p style="color:#888; text-align:center;">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤, –±—É–¥—å –ø–µ—Ä–≤—ã–º!</p>';
          return;
        }

        list.innerHTML = '';
        snapshot.forEach(doc => {
          const data = doc.data();

          // –†–∏—Å—É–µ–º –∑–≤–µ–∑–¥—ã
          let starsHtml = '';
          for (let i = 1; i <= 5; i++) {
            starsHtml += i <= data.rating ? '‚òÖ' : '‚òÜ';
          }

          const reviewEl = document.createElement('div');
          reviewEl.className = 'review-item';

          // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—è–≤–ª—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –≤–æ—à–µ–¥—à–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –≤–ª–∞–¥–µ–ª–µ—Ü –æ—Ç–∑—ã–≤–∞ –∏ UID —Å–æ–≤–ø–∞–¥–∞–µ—Ç
          const canDelete = window.currentUserId && window.currentUserId === data.userId;

          reviewEl.innerHTML = `
            <div class="review-stars">${starsHtml}</div>
            <div class="review-name">${escapeHtml(data.name)}</div>
            <div class="review-text">${escapeHtml(data.comment)}</div>
            ${canDelete ? `<button class="delete-btn" data-id="${doc.id}">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
          `;

          list.appendChild(reviewEl);
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            if (!confirm('–¢—ã —Ç–æ—á–Ω–æ —Ö–æ—á–µ—à—å —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç–∑—ã–≤?')) return;

            try {
              await db.collection('reviews').doc(id).delete();
              alert('–û—Ç–∑—ã–≤ —É–¥–∞–ª—ë–Ω');
              loadReviews();
            } catch (err) {
              alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + err.message);
            }
          });
        });

      } catch (err) {
        list.innerHTML = `<p style="color:#f55; text-align:center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–∑—ã–≤–æ–≤: ${err.message}</p>`;
      }
    }

    // –§—É–Ω–∫—Ü–∏—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å XSS
    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadReviews();

  </script>
</body>
</html>
