<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Отзывы — Бекзат Какимов</title>
  <style>
    /* Твои стили без изменений, не стал вставлять сюда ради объёма,
       ты их уже отлично сделал */
  </style>
</head>
<body>
  <header>Отзывы</header>
  <nav>
    <a href="index.html">Главная</a>
    <a href="about.html">О себе</a>
    <a href="projects.html">Проекты</a>
    <a href="contact.html">Контакты</a>
    <a href="reviews.html">Отзывы</a>
  </nav>

  <main>
    <div class="tabs">
      <button class="tab-button active" data-tab="write">Написать отзыв</button>
      <button class="tab-button" data-tab="view">Посмотреть отзывы</button>
    </div>

    <div id="write" class="tab-content active">
      <form class="review-form" id="reviewForm">
        <label for="name">Имя:</label>
        <input type="text" id="name" name="name" required autocomplete="off" />

        <label>Оценка:</label>
        <div class="stars">
          <input type="radio" id="star5" name="rating" value="5" /><label for="star5">★</label>
          <input type="radio" id="star4" name="rating" value="4" /><label for="star4">★</label>
          <input type="radio" id="star3" name="rating" value="3" /><label for="star3">★</label>
          <input type="radio" id="star2" name="rating" value="2" /><label for="star2">★</label>
          <input type="radio" id="star1" name="rating" value="1" /><label for="star1">★</label>
        </div>

        <label for="comment">Комментарий:</label>
        <textarea id="comment" name="comment" rows="3" class="auto-expand" required></textarea>

        <button type="submit">Отправить</button>
      </form>
    </div>

    <div id="view" class="tab-content">
      <section class="reviews-list" id="reviewsList">
        <p style="color:#888; text-align:center;">Отзывы загружаются после отправки...</p>
      </section>
    </div>
  </main>

  <script>
    // Переключение вкладок
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');

        tabContents.forEach(tab => tab.classList.remove('active'));
        document.getElementById(button.dataset.tab).classList.add('active');
      });
    });

    // Авторазмер textarea
    const autoExpand = textarea => {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    };
    document.querySelectorAll('textarea.auto-expand').forEach(textarea => {
      textarea.addEventListener('input', () => autoExpand(textarea));
      autoExpand(textarea);
    });

    const form = document.getElementById('reviewForm');
    const reviewsList = document.getElementById('reviewsList');

    // Экранируем html спецсимволы для безопасности вывода
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Загружаем отзывы из localStorage (временно, для локального просмотра)
    function loadReviewsLocal() {
      const reviews = JSON.parse(localStorage.getItem('reviews')) || [];
      reviewsList.innerHTML = '';
      if (reviews.length === 0) {
        reviewsList.innerHTML = '<p style="color:#888; text-align:center;">Пока нет отзывов.</p>';
        return;
      }
      reviews.forEach(({ name, rating, comment }) => {
        const div = document.createElement('div');
        div.className = 'review-item';
        div.innerHTML = `
          <div class="review-stars">${'★'.repeat(rating)}${'☆'.repeat(5 - rating)}</div>
          <div class="review-name">${escapeHtml(name)}</div>
          <div class="review-text">${escapeHtml(comment)}</div>
        `;
        reviewsList.appendChild(div);
      });
    }

    // Сохраняем отзыв в localStorage для отображения
    function saveReviewLocally(review) {
      const reviews = JSON.parse(localStorage.getItem('reviews')) || [];
      reviews.push(review);
      localStorage.setItem('reviews', JSON.stringify(reviews));
    }

    // Обработчик отправки формы
    form.addEventListener('submit', async e => {
      e.preventDefault();

      const name = form.name.value.trim();
      const rating = parseInt(form.rating.value);
      const comment = form.comment.value.trim();

      if (!name || !rating || !comment) {
        alert('Заполните все поля!');
        return;
      }

      const data = { name, rating, comment };

      try {
        // ВАЖНО! Вставь сюда свой URL из Google Apps Script (с doPost)
        const response = await fetch('https://script.google.com/macros/s/AKfycbzdpIXzK8thFMoY9uD14_7CWgT_hqsExrPqSTWp2ILqTF2VwlE5txsZbadyLfB8CRbRpg/exec', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          alert('Отзыв успешно отправлен!');
          saveReviewLocally(data);
          form.reset();
          autoExpand(form.comment);
          tabButtons[1].click(); // переключаем на вкладку с отзывами
          loadReviewsLocal();
        } else {
          alert('Ошибка при отправке отзыва!');
        }
      } catch (err) {
        alert('Ошибка соединения: ' + err.message);
      }
    });

    // При загрузке страницы показываем отзывы из localStorage
    window.addEventListener('DOMContentLoaded', loadReviewsLocal);
  </script>
</body>
</html>
